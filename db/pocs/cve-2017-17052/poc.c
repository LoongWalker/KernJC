// https://marc.info/?l=linux-mm&m=150352295801128&w=2
#define _GNU_SOURCE
#include <pthread.h>
#include <stdlib.h>
#include <sys/mman.h>
#include <sys/syscall.h>
#include <sys/wait.h>
#include <unistd.h>

static void *mmap_thread(void *_arg)
{
    for (;;) {
        mmap(NULL, 0x1000000, PROT_READ,
             MAP_POPULATE|MAP_ANONYMOUS|MAP_PRIVATE, -1, 0);
    }
}

static void *fork_thread(void *_arg)
{
    usleep(rand() % 10000);
    fork();
}

int main(void)
{
    fork();
    fork();
    fork();
    for (;;) {
        if (fork() == 0) {
            pthread_t t;

            pthread_create(&t, NULL, mmap_thread, NULL);
            pthread_create(&t, NULL, fork_thread, NULL);
            usleep(rand() % 10000);
            syscall(__NR_exit_group, 0);
        }
        wait(NULL);
    }
}
